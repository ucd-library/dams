# Job Run Integration Docks
# https://cloud.google.com/run/docs/configuring/containers#yaml
# https://cloud.google.com/workflows/docs/reference/googleapis/run/v1/namespaces.jobs/create
# https://cloud.google.com/run/docs/reference/rest/v1/Container#execaction

main:
    params: [args]
    steps:
      - init:
          assign:
            - location: us-central1
            - project_id: digital-ucdavis-edu
            - job_container: gcr.io/ucdlib-pubreg/dams-image-utils
      - get_pages:
          call: http.get
          args:
              url: ${args.baseUrl + "/" + args.workflowId}
          result: workflow_info
      - ocr_pages:
          parallel:
              concurrency_limit: 50
              for:
                  value: page
                  # range : [1, 5]
                  range: ${[0, workflow_info.body.pageCount-1]}
                  steps:
                    - setup_ocr_job:
                        call: googleapis.run.v1.namespaces.jobs.create
                        args:
                            location: ${location}
                            parent: ${"namespaces/" + project_id}
                            body:
                                apiVersion: run.googleapis.com/v1
                                metadata:
                                    name: ${args.workflowId+"-"+page}
                                    labels:
                                        cloud.googleapis.com/location: ${location}
                                    annotations:
                                        run.googleapis.com/launch-stage: ALPHA
                                kind: "Job"
                                spec: 
                                    template:
                                        spec:
                                            template:
                                                spec:
                                                    containers:
                                                        - image: ${job_container}
                                                          resources:
                                                              requests:
                                                                  memory: "2Gi"
                                                                  cpu: "1000m"
                                                              limits:
                                                                  memory: "2Gi"
                                                                  cpu: "1000m"
                                                          command: "node"
                                                          args: ${["cli/pdf-to-ia-reader.js", args.workflowId, page+""]}
                                                          # imagePullPolicy: "Always"
                                                    timeoutSeconds: 300
                                                    serviceAccountName: ${"fin-server@" + project_id + ".iam.gserviceaccount.com"}
                        result: create_job_result
                    - ocr_page:
                        call: googleapis.run.v1.namespaces.jobs.run
                        args:
                            name: ${"namespaces/" + project_id + "/jobs/" + args.workflowId + "-" + page}
                            location: ${location}
                        result: job_execution
                    # - ocr_page:
                    #     call: http.post
                    #     args:
                    #         url: ${args.baseUrl + "/pdf-to-ia-reader/" + args.workflowId + "/" + page}
  # - cleanup:
  #   call: http.delete
  #   args:
  #     url: ${args.baseUrl}/${args.workflowId}