
main:
    params: [args]
    steps:
      - init:
          assign:
            - location: us-central1
            - project_id: digital-ucdavis-edu
      - setup_video_job:
          call: googleapis.run.v1.namespaces.jobs.create
          args:
              location: ${location}
              parent: ${"namespaces/" + project_id}
              body:
                  apiVersion: run.googleapis.com/v1
                  metadata:
                      name: ${"dams-" + args.finWorkflowId}
                      labels:
                          cloud.googleapis.com/location: ${location}
                          project: dams
                          fin-workflow-name: ${args.gcWorkflowName}
                          workflow-step: streaming-video
                      annotations:
                          run.googleapis.com/launch-stage: ALPHA
                  kind: "Job"
                  spec: 
                      template:
                          spec:
                              template:
                                  spec:
                                      containers:
                                          - image: ${args.jobContainer}
                                            resources:
                                                requests:
                                                    memory: "16Gi"
                                                    cpu: "4000m"
                                                limits:
                                                    memory: "16Gi"
                                                    cpu: "4000m"
                                            command: "node"
                                            args: ${["cli/video-to-stream.js", args.finWorkflowId]}
                                      timeoutSeconds: 7200
                                      serviceAccountName: ${"fin-server@" + project_id + ".iam.gserviceaccount.com"}
          result: create_job_result
      - convert_video:
          call: googleapis.run.v1.namespaces.jobs.run
          args:
              name: ${"namespaces/" + project_id + "/jobs/dams-" + args.finWorkflowId}
              location: ${location}
          result: job_execution
      - check_job_status:
          switch:
            - condition: ${job_execution.spec.taskCount != job_execution.status.succeededCount}
              next: end
            - condition: ${job_execution.spec.taskCount == job_execution.status.succeededCount}
              next: job_succeeded
      - job_succeeded:
          call: googleapis.run.v1.namespaces.jobs.delete
          args:
              name: ${"namespaces/" + project_id + "/jobs/dams-" + args.finWorkflowId}
              location: ${location}
          result: job_execution